---
title: "Thesis Simulation Document for Chapter 4"
author: "Dasha Asienga"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    toc: TRUE

---

```{r setup, include=FALSE}
library(mosaic)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(RColorBrewer)
library(knitr)
library(kableExtra)
library(ggplot2)
library(GGally)
library(MASS)
library(reshape2)
library(pROC)
```

$\\$

This file is intended to contain all the code and information to set up the simulation study and supplement Chapter 4.

# Data Generation Mechanism

We're interested in creating a data set that has 50-50 class balance, even across the demographic group, and also has better predictive performance than the COMPAS tool. For this set-up, we will only use 2 variables from the COMPAS data set: 1 continuous variable and 1 categorical variable.

## Reading in the Data

First, let's read in the data. 

```{r}
compas_path <- "/home/dasienga24/Statistics-Senior-Honors-Thesis/Data Sets/COMPAS/compas_seldonian_bw.csv"
compas_sim <- read.csv(compas_path)
```

## Data Subsetting

Next, let's plot the distributions of the continuous variables to choose which one we'll proceed with.

```{r, warning = FALSE, message = FALSE, fig.width = 4.5, fig.height = 3, fig.align = 'center'}
compas_sim %>%
  ggplot(mapping = aes(x = age)) +
  geom_histogram() +
  theme_minimal() +
  labs(title = "Age")
```

```{r, warning = FALSE, message = FALSE, fig.width = 4.5, fig.height = 3, fig.align = 'center'}
compas_sim %>%
  ggplot(mapping = aes(x = priors_count)) +
  geom_histogram() +
  theme_minimal() +
  labs(title = "Priors Count",
       x = "priors count")
```

$\\$

Because age has more variation, we'll use it as our continuous variable. We'll convert `priors_count` into a categorical variable.

```{r}
compas_sim <- compas_sim %>%
  mutate(prior_offense = ifelse(priors_count > 0, 1, 0)) %>%
  dplyr::select(c(race, prior_offense, age, is_recid))
```

$\\$

`age` seems to be a useful predictor for recidivism.

```{r}
favstats(age ~ is_recid, data = compas_sim)
```

$\\$

Whether a defendant has committed a prior offense or not appears to be a useful predictor for recidivism as well. 

```{r, warning = FALSE, message = FALSE, fig.width = 4.5, fig.height = 3, fig.align = 'center'}
compas_sim %>%
  ggplot(mapping = aes(x = as.factor(prior_offense), fill = as.factor(is_recid))) +
  geom_bar() +
  theme_minimal() +
  labs(title = "Committed a Prior Offense",
       fill = "Recidivism",
       x = "prior offense")
```

$\\$

We'll proceed with these 2 variables -- `age` and `prior_offense` for the simulation study. A glimpse of the data is shown below.

```{r}
compas_sim <- compas_sim %>%
  mutate(prior_offense = as.factor(prior_offense),
         is_recid = as.factor(is_recid))

glimpse(compas_sim)
head(compas_sim)
```

## Generating the Parent Simulation Data Set

We want a setting with 50-50 class balance for each combination of race and recidivism status. To achieve that, we'll perform sample observations with replacement. Let's create a data set with 1250 observations in each of these 4 groups, hence, 5000 observations total.

$\\$

First, let's subset these 4 groups.

```{r}
compas_b_y <- compas_sim %>%
  filter(race == "African-American" & is_recid == 1)

compas_b_n <- compas_sim %>%
  filter(race == "African-American" & is_recid == 0)

compas_w_y <- compas_sim %>%
  filter(race == "Caucasian" & is_recid == 1)

compas_w_n <- compas_sim %>%
  filter(race == "Caucasian" & is_recid == 0)
```

$\\$

Next, let's randomly sample 1250 observations from each of these groups.

```{r}
compas_b_y_balanced <- compas_b_y[sample(nrow(compas_b_y), 1250, replace = TRUE),]
compas_b_n_balanced <- compas_b_n[sample(nrow(compas_b_n), 1250, replace = TRUE),]
compas_w_y_balanced <- compas_w_y[sample(nrow(compas_w_y), 1250, replace = TRUE),]
compas_w_n_balanced <- compas_w_n[sample(nrow(compas_w_n), 1250, replace = TRUE),]
```

$\\$

Finally, let's union all these together into a single data set.

```{r}
compas_sim_balanced <- rbind(compas_b_y_balanced, 
                             compas_b_n_balanced, 
                             compas_w_y_balanced, 
                             compas_w_n_balanced)
```

$\\$

Let's also shuffle the data set row orderings to aid the machine learning algorithms later.

```{r}
compas_sim_balanced <- compas_sim_balanced[sample(nrow(compas_sim_balanced), 
                                                  5000, 
                                                  replace = FALSE),]
```

$\\$

The parent data set is now ready. 

## Examining Distributions of the Recidivism in the Parent Data Set

The bar plot below shows that we've achieve perfect class balance.

```{r, warning = FALSE, message = FALSE, fig.width = 4.5, fig.height = 3, fig.align = 'center'}
compas_sim_balanced %>%
  ggplot(mapping = aes(x = is_recid)) +
  geom_bar() +
  theme_minimal() +
  labs(x = "Recidivism",
       title = "Recidivism Prevalence")
```

$\\$

The bar plot below reveals that the balance is preserved by race as well. 

```{r, warning = FALSE, message = FALSE, fig.width = 4.5, fig.height = 3, fig.align = 'center'}
compas_sim_balanced %>%
  ggplot(mapping = aes(x = is_recid, fill = race)) +
  geom_bar() +
  theme_minimal() +
  labs(x = "Recidivism",
       title = "Recidivism Prevalence by Race")
```

## Assessing Baseline Predictive Performance of the Parent Data Set 

# Seldonian Algorithms for Classification {#chap-3}

```{r, include = FALSE}
library(mosaic)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(RColorBrewer)
library(knitr)
library(kableExtra)
library(ggplot2)
library(GGally)
library(MASS)
library(gridExtra)
```

Chapter \@ref(chap-2) introduced the Seldonian framework, which offers probabilistic guarantees for satisfying defined behavioral constraints. Although impractical, the toy linear regression example demonstrated how Seldonian algorithms may be employed in a setting with a continuous real-valued response variable.

However, machine learning algorithms deal with classification problems in many practical applications. Applications range from risk assessment tools like COMPAS, discussed in Chapter \@ref(intro), to credit scoring and employment prediction algorithms, to name a few. However, deploying such algorithms raises significant ethical concerns, as discussed in Chapters \@ref(intro) and \@ref(chap-2), primarily regarding fairness and the potential reinforcement of discriminatory practices. Given the historical and social biases inherent in the data used to train these algorithms, there is a pressing need to assess their fairness and mitigate any potential harm they may cause disadvantaged groups.

To offer a path forward in addressing this issue, this chapter aims to apply the Seldonian framework to the COMPAS data set and assess its predictive outcomes compared to those from the COMPAS tool and those from logistic regression, a standard ML procedure. Specifically, the objective is to assess whether Seldonian approaches can produce fairer outcomes, particularly COMPAS outcomes, drawing on some of the statistical definitions of fairness defined in Chapter \@ref(fairnessdefinitions). This chapter will present a framework that can be emulated in other classification problems where fairness is a concern. 


## The COMPAS Data Set

```{r, echo = FALSE}
# read in the data
compas_path <- "/home/dasienga24/Statistics-Senior-Honors-Thesis/Data Sets/COMPAS/compas_data.csv"
compasdata <- read.csv(compas_path)

# clean the data
compasdata <- compasdata %>%
  filter(decile_score > 0 & is_recid != -1 & days_b_screening_arrest >= -30 &
           days_b_screening_arrest <= 30) %>%
  mutate(days_b_screening_arrest = abs(days_b_screening_arrest))

# remove duplicates
clean_compasdata <- compasdata[-which(duplicated(compasdata$id)), ]
```

The COMPAS data set, obtained from the ProPublica Data Store [@compasdata], records information on defendants from Broward County, Florida that were evaluated for the risk of recidivism by the Correctional Offender Management Profiling for Alternative Sanctions (COMPAS) tool in 2013 and 2014. The data is stored in a database and a SQL query, displayed in Appendix \@ref(appendix-c), retrieved 12160 observations. There are 29 variables, 6 of which were identified to be useful for predictive analysis: age, age category, sex, marital status, whether the defendant had a history of juvenile offenses or not, and the total number of prior offenses committed by the defendant. The response variable records whether or not a defendant had recommitted a crime within two years. Finally, the protected attribute, race, has 6 levels: African-American, Caucasian, Hispanic, Asian, Native American, and Other. After cleaning the data to address some anomalies, improve the data quality, and remove duplicate observations, the data set size reduced to 9387 observations. Section \@ref(descriptivestats) examines these variables in more detail as well as their relationships with each other.

## Descriptive Statistics {#descriptivestats}

### Univariate Analysis

The six predictive variables are age, age category, sex, marital status, whether the defendant had a history of juvenile offenses or not, and the total number of prior offenses committed by the defendant. There are only two continuous variables: the number of prior offenses and the age of the defendant. The remaining variables are categorical.

#### Continuous Predictors

The age of the defendants ranges from 18 to 96, with a median of 32 years and a mean of 34.75 years. There is a right skew as illustrated on Figure \@ref(fig:ch3fig1) and the middle 50% of the defendants are between the ages of 25 and 42. Similarly, the variable recording the number of prior offenses has a significant right skew with median of 1 offense and a mean of 3.02 offenses. The middle 50% of the defendants have committed between 0 and 4 offenses, and the defendant with the most prior offenses has committed 38 crimes. Figure \@ref(fig:ch3fig1) visualizes this distribution.

```{r ch3fig1, fig.align='center', fig.cap="Distribution of the COMPAS Continuous Variables", warning = FALSE, message = FALSE, fig.width = 6, fig.height = 3, echo = FALSE}
g1 <- ggplot(data = clean_compasdata, mapping = aes(x = age)) +
  geom_histogram(fill = "lightblue", color = "black") +
  theme_minimal() +
  labs(title = "Age")

g2 <- ggplot(data = clean_compasdata, mapping = aes(x = priors_count)) +
  geom_histogram(fill = "lightblue", color = "black") +
  theme_minimal() +
  labs(x = "priors",
       title = "Prior Offenses")

grid.arrange(g1, g2, nrow = 1)
```


#### Categorical Predictors

Sex has two levels: male or female. There are 7457 males and 1930 females in the data set. The age category variable classifies participants as either 'Less than 25', '25 - 45', or 'Greater than 45' -- there are 2009, 5366, and 2012 observations in each group respectively. There are seven different levels of marital status. In descending order, they are: single (7202), married (1138), divorced (398), significant other (332), separated (219), unknown (58), and widowed (40). Finally, 8254 defendants had no record of juvenile offenses, with only 1133 defendants having such a record. Figure \@ref(fig:ch3fig2) visually displays the distribution of these variables.

```{r ch3fig2, fig.align='center', fig.cap="Distribution of the COMPAS Categorical Variables", warning = FALSE, message = FALSE, fig.width = 6, fig.height = 6, echo = FALSE}
g3 <- ggplot(data = clean_compasdata, mapping = aes(x = sex)) +
  geom_bar(fill = "lightblue", color = "black") +
  theme_minimal() +
  labs(title = "Sex")

order <- c("Less than 25", "25 - 45", "Greater than 45")

g4 <- ggplot(data = clean_compasdata, mapping = aes(x = age_cat)) +
  geom_bar(fill = "lightblue", color = "black") +
  theme_minimal() +
  scale_x_discrete(limits = order) +
  labs(x = "Age Category",
       title = "Age Categories")

g5 <- ggplot(data = clean_compasdata, mapping = aes(x = marital_status)) +
  geom_bar(fill = "lightblue", color = "black") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 25, vjust = 1.2, hjust=1)) +
  labs(x = "Marital Status",
       title = "Marital Status") 

clean_compasdata <- clean_compasdata %>%
  mutate(juv_offense_count = juv_fel_count + juv_misd_count + juv_other_count,
         juv_offense = ifelse(juv_offense_count == 0, 0, 1))

g6 <- clean_compasdata %>%
  mutate(juv_offense = ifelse(juv_offense == 0, "No", "Yes")) %>%
  ggplot(mapping = aes(x = juv_offense)) +
  geom_bar(fill = "lightblue", color = "black") +
  theme_minimal() +
  labs(x = "Committed a Juvenile Offense",
       title = "Juvenile Offense Record")

grid.arrange(g3, g4, g5, g6, ncol = 2, nrow = 2)

```


#### Response Variable

The response variable records whether or not a defendant recommitted any crime within two years. Figure \@ref(fig:ch3fig3) illustrates that about two-thirds (6199) of the defendants did not recommit a crime within two years, while one-thirds (3188) did. This is indicative of class imbalance, which, in many cases, affects the performance of machine learning classification algorithms. This will be important when assessing model performance in the proceeding sections. 

```{r ch3fig3, fig.align='center', fig.cap="Distribution of the COMPAS Response Variable: Recidivism", warning = FALSE, message = FALSE, fig.width = 4.5, fig.height = 3, echo = FALSE}
clean_compasdata %>%
mutate(is_recid = ifelse(is_recid == 0, "No", "Yes")) %>%
ggplot(mapping = aes(x = is_recid)) +
  geom_bar(fill = "lightblue", color = "black") +
  theme_minimal() +
  labs(title = "Recidivism",
       x = "Recommitted a Crime Within 2 Years")
```

#### Demographic Variable

Finally, the demographic variable in this analysis is race. Most of the defendants are African-American (4674) and Caucasian (3250), with only 818 Hispanic, 48 Asian, and 27 Native American defendants. The remaining 570 defendants are classified as 'Other'. Figure \@ref(fig:ch3fig4) visualizes this.

```{r ch3fig4, fig.align='center', fig.cap="Distribution of the COMPAS Demographic Variable: Race", warning = FALSE, message = FALSE, fig.width = 4.5, fig.height = 3, echo = FALSE}
ggplot(data = clean_compasdata, mapping = aes(x = race)) +
  geom_bar(fill = "lightblue", color = "black") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 25, vjust = 1.2, hjust=1)) +
  labs(title = "Race")
```

### Bivariate Analysis

### Multivariate Analysis

## Demographic Group Analysis

add compas univariate analysis visualizations 

## Logistic Regression

## Seldonian Classification

## Results











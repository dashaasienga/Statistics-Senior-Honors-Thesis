`r if(knitr:::is_latex_output()) '\\appendix'`

`r if(!knitr:::is_latex_output()) '# (APPENDIX) Appendix {-}'` 
<!--
The first appendix must start with the above text. Do not remove!
-->

# Sufficiency v Separation Fairness Conflict Equation {#appendix-a}

Recall from Chapter \@ref(intro) that [@castelnovo2022clarification]:

$$ PPV = P(Y=1|\hat{Y} = 1),$$
$$ FPR = P(\hat{Y} = 1| Y = 0),$$
$$FNR = P(\hat{Y} = 0| Y = 1),$$
$$ p = P(Y=1).$$

\noindent Using Bayes' rule,

$$PPV = P(Y=1|\hat{Y} = 1) = \frac{P(\hat{Y} = 1|Y=1)P(Y=1)}{P(\hat{Y} = 1|Y=1)P(Y=1) + P(\hat{Y} = 1|Y=0)P(Y=0)} $$
$$\Rightarrow PPV = \frac{P(\hat{Y} = 1|Y=1)p}{P(\hat{Y} = 1|Y=1)p + P(\hat{Y} = 1|Y=0)(1-p)}$$

$$\Rightarrow PPV = \frac{(1-FNR)p}{(1-FNR)p + FPR(1-p)}$$

$$\Rightarrow (1-FNR)p + FPR(1-p) = \frac{(1-FNR)p}{PPV}$$
$$\Rightarrow FPR(1-p) = \frac{(1-FNR)p}{PPV} - (1-FNR)p$$
$$\Rightarrow FPR = \frac{(1-FNR)p}{PPV(1-p)} - \frac{(1-FNR)p}{(1-p)}$$
$$\Rightarrow FPR = \frac{p}{1-p} \left[  \frac{(1-FNR)}{PPV} - (1-FNR) \right]$$
$$\Rightarrow FPR = \frac{p}{1-p} \left[  \frac{(1-FNR) - PPV(1-FNR)}{PPV} \right]$$
$$\Rightarrow FPR = \frac{p}{1-p} \left[  \frac{(1-FNR) (1 - PPV)}{PPV} \right]$$
$$\Rightarrow FPR = \frac{p}{1-p} \frac{1 - PPV}{PPV} (1-FNR) \blacksquare.$$

\noindent A similar equation can be derived relating $NPV = P(Y=0|\hat{Y} = 0)$ and both FPR and FNR. 

$\\$

\noindent Additionally, in conventional statistics notation, the sensitivity of a prediction tool can be defined as $P(\hat{Y}=1|Y=1) = 1 - FNR$ and its specificity can be defined as $P(\hat{Y}=0|Y=0) = 1 - FPR$. Given a prevalence $p$, sensitivity $s_e$, and specificity $s_p$, then:

$$PPV = \frac{s_ep}{s_ep + (1-s_p)(1-p)}.$$

\noindent Similarly, it can shown that: 

$$NPV = \frac{s_p(1-p)}{(1-s_e)p + s_p(1-p)}.$$

\noindent The R code chunk below fixes arbitrary sensitivity (1 - FNR) and specificity (1 - FPR) values to illustrate through the proceeding plots that as prevalence varies, then PPV/ NPV varies and cannot be equal as long as sensitivity and specificity are held constant, hence a conflict. 

```{r, warning=FALSE, message=FALSE}
library(dplyr)
library(ggplot2)
library(gridExtra)
```

```{r, fig.align='center'}
ppv <- function(p, sens, spec){
  ppv <- (sens*p)/((sens*p) + ((1-spec)*(1-p)))
  return(ppv)
}

npv <- function(p, sens, spec){
  npv <- (spec*(1-p))/(((1-sens)*p) + (spec*(1-p)))
  return(npv)
}

dat_8080 <- data.frame(prevalence = seq(0.05,0.95,0.05)
                       , sens=0.80
                       , spec=0.80
                       , ppv = ppv(p=seq(0.05,0.95,0.05), 
                                   sens=0.80, 
                                   spec=0.80)
                       , npv = npv(p=seq(0.05,0.95,0.05), 
                                   sens=0.80, 
                                   spec=0.80))

dat_9090 <- data.frame(prevalence = seq(0.05,0.95,0.05)
                       , sens=0.90
                       , spec=0.90
                       , ppv = ppv(p=seq(0.05,0.95,0.05), 
                                   sens=0.90, 
                                   spec=0.90)
                       , npv = npv(p=seq(0.05,0.95,0.05), 
                                   sens=0.90, 
                                   spec=0.90))

dat_9070 <- data.frame(prevalence = seq(0.05,0.95,0.05)
                       , sens=0.90
                       , spec=0.70
                       , ppv = ppv(p=seq(0.05,0.95,0.05), 
                                   sens=0.90, 
                                   spec=0.70)
                       , npv = npv(p=seq(0.05,0.95,0.05), 
                                   sens=0.90, 
                                   spec=0.70))

dat_7090 <- data.frame(prevalence = seq(0.05,0.95,0.05)
                       , sens=0.70
                       , spec=0.90
                       , ppv = ppv(p=seq(0.05,0.95,0.05), 
                                   sens=0.70, 
                                   spec=0.90)
                       , npv = npv(p=seq(0.05,0.95,0.05), 
                                   sens=0.70, 
                                   spec=0.90))

dat_all <- bind_rows(dat_8080, dat_7090, dat_9070, dat_9090) |>
  mutate(sens_spec = paste0("Sensitivity: ", sens, 
                            "\n Specificity: ", spec)
         , fpr = 1 - spec
         , fnr = 1 - sens)

g1 <- ggplot(dat_all, aes(x=prevalence, y=ppv)) +
        geom_point() + 
        labs(x="prevalence", y="positive predictive value",
             title = "PPV-FPR-FNR Conflict") +
        facet_wrap(~sens_spec) +
  theme_minimal()
 
g2 <- ggplot(dat_all, aes(x=prevalence, y=npv)) +
        geom_point() + 
        labs(x="prevalence", y="negative predictive value",
             title = "NPV-FPR-FNR Conflict") +
        facet_wrap(~sens_spec) +
  theme_minimal()

grid.arrange(g1,g2, nrow=1, ncol=2)
```



